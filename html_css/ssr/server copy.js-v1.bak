import express, { response } from 'express'
import {readFile, writeFile} from 'node:fs/promises'
import {cors} from 'cors'


const app = express()
app.use(cors())
app.use(express.json()) // parse json

const port = 3001
app.get('/', (req, res) => {
    console.dir(req.params)
    res.send('hahh12121212as')
})
app.get('/todos', async (_req, res) => {
    const todosData = await readFile('./data.json', 'utf-8')
    const todos = JSON.parse(todosData)
    return res.status(200).json(todos)
})

app.get('/todos/:todoId', async (req, res) => {
    const todoData = await readFile('./data.json', 'utf-8')
    const todos = JSON.parse(todoData)
    const todoId = req.params.todoId
    console.log('todos')
    console.log(todos)
    const todo = todos.find((todo) => todo.id === Number(todoId))
    if (todo) {
        return res.status(200).json(todo)
    }
    return res.status(404).send(
        '404 not found'
    )
})
app.get('/todos/delete/:todoId', async (req, res) => {
    const todoData = await readFile('./data.json', 'utf-8')
    const todos = JSON.parse(todoData)
    const todoId = req.params.todoId
    const filterTodos = todos.filter((todo) => todo.id !== Number(todoId))

    await writeFile('./data.json', JSON.stringify(filterTodos), 'utf-8')
    return res.status(200).json({
        message: 'todo deleted success!'
    })
})

/**
app.get('/todos/add/:addTodo', async (req, res) => {
    const todoData = await readFile('./data.json', 'utf-8')
    const todos = JSON.parse(todoData)
    const addTodo = req.params.addTodo
    const parsedAddTodo = JSON.parse(addTodo)
    const updatedTodos = [...todos, parsedAddTodo]
    await writeFile('./data.json', JSON.stringify(updatedTodos), 'utf-8')
    return res.status(404).json({
        message: 'todo added success'
    })
})
**/
app.get('/todos/add', async (req, res) => {
    const todoData = await readFile('./data.json', 'utf-8')
    const todos = JSON.parse(todoData)
    const addTodo = req.body
    if (!addTodo) {
        return res.status(404).json({
            message: 'Bad request'
        })
    }

    const updatedTodos = [
        ...todos,
        addTodo
    ]

    await writeFile('./data.json', JSON.stringify(updatedTodos), 'utf-8')
    return res.status(404).json({
        message: 'todo added success'
    })
})

app.get('/todos/update/:updateTodo', async (req, res) => {
    const todoData = await readFile('./data.json', 'utf-8')
    const todos = JSON.parse(todoData)
    const updateTodo = req.params.updateTodo
    const parseUpdateTodo = JSON.parse(updateTodo)
    const updatedTodos = todos.map((todo) => {
        if (todo.id === parseUpdateTodo.id) {
            return {
                ...todo,
                ...parseUpdateTodo
            }
        }
        return todo;
    })
    await writeFile('./data.json', JSON.stringify(updatedTodos), 'utf-8')
    return res.status(404).json({
        message: 'todo update success'
    })
})

app.listen(port, () => {
    console.log(`run http:localhost:/${port}`)
})

app
